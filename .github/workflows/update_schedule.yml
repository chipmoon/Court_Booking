name: Update Court Availability

on:
  schedule:
    # Run every 30 minutes
    - cron: '0,30 7-14 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create credentials file
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "$GOOGLE_CREDENTIALS" > credentials.json
      
      - name: Update availability dashboard
        env:
          GOOGLE_CREDENTIALS_PATH: credentials.json
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          python -m src.main update
      
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f credentials.json
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Court booking update failed',
              body: `Automated update failed at ${new Date().toISOString()}. Check [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}).`,
              labels: ['bug', 'automation']
            })
